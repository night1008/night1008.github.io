<?xml version='1.0' encoding='UTF-8'?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" version="2.0"><channel><title>Night1008</title><link>https://night1008.github.io</link><description>静以修身，俭以养德</description><copyright>Night1008</copyright><docs>http://www.rssboard.org/rss-specification</docs><generator>python-feedgen</generator><image><url>https://github.githubassets.com/favicons/favicon.svg</url><title>avatar</title><link>https://night1008.github.io</link></image><lastBuildDate>Sun, 09 Jun 2024 06:43:47 +0000</lastBuildDate><managingEditor>Night1008</managingEditor><ttl>60</ttl><webMaster>Night1008</webMaster><item><title>Go 如何实现 Clickhouse 查询缓存</title><link>https://night1008.github.io/post/Go%20-ru-he-shi-xian-%20Clickhouse%20-cha-xun-huan-cun.html</link><description>**整体思路：先判断是否命中缓存，没有的话再进入查询队列**&#13;
&#13;
依赖的包&#13;
```&#13;
https://github.com/ClickHouse/ClickHouse&#13;
&#13;
https://github.com/prashanthpai/sqlcache =&gt; https://github.com/night1008/sqlcache&#13;
&#13;
https://github.com/DATA-DOG/go-sqlmock&#13;
&#13;
https://github.com/blockloop/scan&#13;
```&#13;
&#13;
现在的问题是 clickhouse 的查询结果可能返回复杂类型，比如 Map(String, UInt8)，&#13;
如果命中缓存，缓存的结果为 `driver.Rows`，需要转换成 `*sql.Rows` 方便后续使用，&#13;
因此想到通过 `sqlmock` 的方式，但是默认的 `value converter` 是 `driver.DefaultParameterConverter`，只能转换基础类型，&#13;
复杂类型也没有定义专门用于解析的结构体，会报诸如以下的错误，&#13;
&#13;
&gt; panic: row #1, column #2 ('mapper') type map[string]uint8: unsupported type map[string]uint8, a map&#13;
&#13;
好在 `go-sqlmock` 可以指定 `ValueConverterOption`，这样就可以把 `driver.Rows` 转换成 `*sql.Rows` 了。</description><guid isPermaLink="true">https://night1008.github.io/post/Go%20-ru-he-shi-xian-%20Clickhouse%20-cha-xun-huan-cun.html</guid><pubDate>Sun, 09 Jun 2024 06:43:22 +0000</pubDate></item><item><title>Go 有趣的代码片段</title><link>https://night1008.github.io/post/Go%20-you-qu-de-dai-ma-pian-duan.html</link><description>### 可以对 error 进行 switch 判断&#13;
&#13;
来源 https://github.com/prashanthpai/sqlcache/blob/4bf943bfd00f02394a480c5437e86af4b5be074c/cache_redis.go#L24&#13;
&#13;
```go&#13;
func (r *Redis) Get(ctx context.Context, key string) (*cache.Item, bool, error) {&#13;
	b, err := r.c.Get(ctx, r.keyPrefix+key).Bytes()&#13;
	switch err {&#13;
	case nil:&#13;
		var item cache.Item&#13;
		if err := msgpack.Unmarshal(b, &amp;item); err != nil {&#13;
			return nil, true, err&#13;
		}&#13;
		return &amp;item, true, nil&#13;
	case redis.Nil:&#13;
		return nil, false, nil&#13;
	default:&#13;
		return nil, false, err&#13;
	}&#13;
}&#13;
```。</description><guid isPermaLink="true">https://night1008.github.io/post/Go%20-you-qu-de-dai-ma-pian-duan.html</guid><pubDate>Sat, 01 Jun 2024 13:01:05 +0000</pubDate></item><item><title>分析平台中的业务关系图</title><link>https://night1008.github.io/post/fen-xi-ping-tai-zhong-de-ye-wu-guan-xi-tu.html</link><description>### 用户和应用角色之间的关系&#13;
![user_role_permission](https://github.com/night1008/night1008.github.io/assets/3940006/214e5136-2ac8-453f-8ddb-e4cd865e4027)&#13;
&#13;
---&#13;
&#13;
### 表和属性之间的关系&#13;
![event_property](https://github.com/night1008/night1008.github.io/assets/3940006/33933ff6-4c26-434b-a190-3ed98f2b5bc9)&#13;
&#13;
&#13;
---&#13;
&#13;
### 看板空间和看板之间的关系&#13;
![dashboard_space](https://github.com/night1008/night1008.github.io/assets/3940006/40200478-f311-40a1-ba05-1e3e0a80a394)&#13;
。</description><guid isPermaLink="true">https://night1008.github.io/post/fen-xi-ping-tai-zhong-de-ye-wu-guan-xi-tu.html</guid><pubDate>Thu, 25 Apr 2024 09:17:32 +0000</pubDate></item><item><title>如何在 iOS 上安装 PokeMMO</title><link>https://night1008.github.io/post/ru-he-zai-%20iOS%20-shang-an-zhuang-%20PokeMMO.html</link><description>准备条件：&#13;
1.  [PokeMMO Account](https://pokemmo.com/en/)&#13;
2. [AltStore](https://iosdroids.com/altstore/)&#13;
3. [PokeMMO ROMS](https://iosdroids.com/pokemmo-ios/)&#13;
&#13;
找了好久总算在 [How to Download &amp; Install PokeMMO on iOS?](https://iosdroids.com/pokemmo-ios/) 找到可下载的 PokeMMO ROMS.&#13;
。</description><guid isPermaLink="true">https://night1008.github.io/post/ru-he-zai-%20iOS%20-shang-an-zhuang-%20PokeMMO.html</guid><pubDate>Sun, 14 Apr 2024 14:55:47 +0000</pubDate></item><item><title>clickhouse-go 某些查询不会返回查询错误</title><link>https://night1008.github.io/post/clickhouse-go%20-mou-xie-cha-xun-bu-hui-fan-hui-cha-xun-cuo-wu.html</link><description>使用 [clickhouse-go](https://github.com/ClickHouse/clickhouse-go) 作为客户端进行 clickhouse 查询时，发现某些查询不会返回查询错误，&#13;
1. 查询时间超过最大查询时间参数 (max_execution_time)&#13;
2. 非法查询，比如 sleep(300)&#13;
&#13;
下面给示例，&#13;
&#13;
```go&#13;
package main&#13;
&#13;
import (&#13;
	'context'&#13;
	'fmt'&#13;
	'log'&#13;
&#13;
	'github.com/ClickHouse/clickhouse-go/v2'&#13;
)&#13;
&#13;
func main() {&#13;
	db := clickhouse.OpenDB(&amp;clickhouse.Options{&#13;
		Addr: []string{'127.0.0.1:9000'},&#13;
		Auth: clickhouse.Auth{&#13;
			Database: 'default',&#13;
			Username: 'default',&#13;
			Password: '',&#13;
		},&#13;
		Settings: clickhouse.Settings{&#13;
			'join_use_nulls': 1,&#13;
		},&#13;
	})&#13;
&#13;
	ctx := context.Background()&#13;
	conn, err := db.Conn(ctx)&#13;
	if err != nil {&#13;
		log.Fatal(err)&#13;
	}&#13;
	defer conn.Close()&#13;
&#13;
	sql := 'select sleep(300)'&#13;
	rows, err := conn.QueryContext(ctx, sql)&#13;
	if err != nil {&#13;
		log.Fatal(err)&#13;
	}&#13;
	defer rows.Close()&#13;
&#13;
	fmt.Println(rows.Columns())&#13;
}&#13;
```&#13;
&#13;
期望结果是，&#13;
```&#13;
code: 160, message: The maximum sleep time is 3000000 microseconds. Requested: 300: while executing 'FUNCTION sleep(300 :: 0) -&gt; sleep(300) UInt8 : 1'&#13;
```&#13;
&#13;
执行结果是，&#13;
```&#13;
[sleep(300)] &lt;nil&gt;&#13;
```&#13;
&#13;
---&#13;
&#13;
问了官方，说是，&#13;
Since the error is not thrown in ClickHouse at the time of query retrieval but later with the data packet, the client has to process data received from the server explicitly using rows.Next().&#13;
&#13;
See code snippet:&#13;
```go&#13;
package issues&#13;
&#13;
import (&#13;
	'context'&#13;
	'testing'&#13;
&#13;
	clickhouse_tests 'github.com/ClickHouse/clickhouse-go/v2/tests'&#13;
	'github.com/stretchr/testify/assert'&#13;
	'github.com/stretchr/testify/require'&#13;
)&#13;
&#13;
func Test1268(t *testing.T) {&#13;
	conn, err := clickhouse_tests.GetDatabaseSQLConnection('issues', nil, nil, nil)&#13;
	require.NoError(t, err)&#13;
&#13;
	rows, err := conn.QueryContext(context.Background(), 'select sleep(300)')&#13;
	require.NoError(t, err)&#13;
	defer rows.Close()&#13;
&#13;
	for rows.Next() {&#13;
		if rows.Err() != nil {&#13;
			break&#13;
		}&#13;
	}&#13;
&#13;
	assert.ErrorContains(t, rows.Err(), 'code: 160, message: The maximum sleep time is 3000000 microseconds.')&#13;
}&#13;
```。</description><guid isPermaLink="true">https://night1008.github.io/post/clickhouse-go%20-mou-xie-cha-xun-bu-hui-fan-hui-cha-xun-cuo-wu.html</guid><pubDate>Sun, 14 Apr 2024 04:00:07 +0000</pubDate></item><item><title>Go 语言下如何提交包含反引号的多行字符串表单</title><link>https://night1008.github.io/post/Go%20-yu-yan-xia-ru-he-ti-jiao-bao-han-fan-yin-hao-de-duo-xing-zi-fu-chuan-biao-dan.html</link><description>感觉 Go 语言对于多行字符串的支持不是很友好。</description><guid isPermaLink="true">https://night1008.github.io/post/Go%20-yu-yan-xia-ru-he-ti-jiao-bao-han-fan-yin-hao-de-duo-xing-zi-fu-chuan-biao-dan.html</guid><pubDate>Sun, 14 Apr 2024 03:57:34 +0000</pubDate></item><item><title>如何实现超管登录</title><link>https://night1008.github.io/post/ru-he-shi-xian-chao-guan-deng-lu.html</link><description>对于 ToC 平台，随着接入应用的增加，用户反馈的问题也变多，&#13;
日志没有记录到的话，加上现有的权限体系下查看问题不方便，&#13;
很难复现问题，需要一个个加到对应的应用中。</description><guid isPermaLink="true">https://night1008.github.io/post/ru-he-shi-xian-chao-guan-deng-lu.html</guid><pubDate>Thu, 15 Feb 2024 04:40:48 +0000</pubDate></item><item><title>如何进行前后端静态资源分离</title><link>https://night1008.github.io/post/ru-he-jin-xing-qian-hou-duan-jing-tai-zi-yuan-fen-li.html</link><description>我目前开发的平台的前端静态资源是使用 [go embed](https://pkg.go.dev/embed) 机制内嵌到后端服务中，&#13;
当访问量比较大的时候，服务器会有比较大的 IO 消耗，因此进行前端静态资源分离。</description><guid isPermaLink="true">https://night1008.github.io/post/ru-he-jin-xing-qian-hou-duan-jing-tai-zi-yuan-fen-li.html</guid><pubDate>Wed, 14 Feb 2024 04:40:48 +0000</pubDate></item></channel></rss>